# ğŸš¨ Prometheus å‘Šè­¦è§„åˆ™é…ç½®
# å®šä¹‰å…³é”®ä¸šåŠ¡å’Œç³»ç»ŸæŒ‡æ ‡çš„å‘Šè­¦é˜ˆå€¼

groups:
  # ğŸ”¥ åº”ç”¨æœåŠ¡å‘Šè­¦
  - name: nutrition-app-alerts
    rules:
      # åº”ç”¨æœåŠ¡ä¸å¯ç”¨
      - alert: AppServiceDown
        expr: up{job="nutrition-app"} == 0
        for: 1m
        labels:
          severity: critical
          service: nutrition-app
        annotations:
          summary: "è¥å…»åˆ†æåº”ç”¨æœåŠ¡ä¸å¯ç”¨"
          description: "åº”ç”¨æœåŠ¡å·²åœæ­¢å“åº”è¶…è¿‡1åˆ†é’Ÿ"

      # é«˜é”™è¯¯ç‡
      - alert: HighErrorRate
        expr: |
          (
            rate(http_requests_total{job="nutrition-app",status=~"5.."}[5m]) /
            rate(http_requests_total{job="nutrition-app"}[5m])
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          service: nutrition-app
        annotations:
          summary: "åº”ç”¨é”™è¯¯ç‡è¿‡é«˜"
          description: "5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡5%: {{ $value }}%"

      # å“åº”æ—¶é—´è¿‡é•¿
      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(http_request_duration_seconds_bucket{job="nutrition-app"}[5m])
          ) > 3
        for: 5m
        labels:
          severity: warning
          service: nutrition-app
        annotations:
          summary: "åº”ç”¨å“åº”æ—¶é—´è¿‡é•¿"
          description: "95%è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡3ç§’: {{ $value }}s"

      # å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜
      - alert: HighMemoryUsage
        expr: |
          (container_memory_usage_bytes{name="nutrition_app"} / 
           container_spec_memory_limit_bytes{name="nutrition_app"}) * 100 > 80
        for: 10m
        labels:
          severity: warning
          service: nutrition-app
        annotations:
          summary: "åº”ç”¨å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%: {{ $value }}%"

      # CPUä½¿ç”¨ç‡è¿‡é«˜
      - alert: HighCPUUsage
        expr: |
          rate(container_cpu_usage_seconds_total{name="nutrition_app"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          service: nutrition-app
        annotations:
          summary: "åº”ç”¨CPUä½¿ç”¨ç‡è¿‡é«˜"
          description: "CPUä½¿ç”¨ç‡è¶…è¿‡80%: {{ $value }}%"

  # ğŸ—„ï¸ æ•°æ®åº“å‘Šè­¦
  - name: database-alerts
    rules:
      # æ•°æ®åº“æœåŠ¡ä¸å¯ç”¨
      - alert: DatabaseDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "æ•°æ®åº“æœåŠ¡ä¸å¯ç”¨"
          description: "PostgreSQLæ•°æ®åº“å·²åœæ­¢å“åº”è¶…è¿‡1åˆ†é’Ÿ"

      # æ•°æ®åº“è¿æ¥æ•°è¿‡å¤š
      - alert: TooManyDatabaseConnections
        expr: |
          pg_stat_database_numbackends{datname="nutrition_db"} > 80
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡å¤š"
          description: "æ•°æ®åº“è¿æ¥æ•°è¶…è¿‡80: {{ $value }}"

      # æ•°æ®åº“æŸ¥è¯¢æ—¶é—´è¿‡é•¿
      - alert: SlowDatabaseQueries
        expr: |
          pg_stat_activity_max_tx_duration{datname="nutrition_db"} > 300
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "æ•°æ®åº“æŸ¥è¯¢æ—¶é—´è¿‡é•¿"
          description: "æœ€é•¿æŸ¥è¯¢æ—¶é—´è¶…è¿‡5åˆ†é’Ÿ: {{ $value }}s"

      # æ•°æ®åº“ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜
      - alert: DatabaseDiskSpaceHigh
        expr: |
          (pg_database_size_bytes{datname="nutrition_db"} / 
           (1024*1024*1024)) > 8
        for: 10m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "æ•°æ®åº“ç£ç›˜ä½¿ç”¨é‡è¿‡é«˜"
          description: "æ•°æ®åº“å¤§å°è¶…è¿‡8GB: {{ $value }}GB"

  # ğŸ”„ Rediså‘Šè­¦
  - name: redis-alerts
    rules:
      # RedisæœåŠ¡ä¸å¯ç”¨
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "RedisæœåŠ¡ä¸å¯ç”¨"
          description: "Redisç¼“å­˜æœåŠ¡å·²åœæ­¢å“åº”è¶…è¿‡1åˆ†é’Ÿ"

      # Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜
      - alert: RedisMemoryHigh
        expr: |
          (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 80
        for: 10m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "Rediså†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%: {{ $value }}%"

      # Redisè¿æ¥æ•°è¿‡å¤š
      - alert: RedisConnectionsHigh
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redisè¿æ¥æ•°è¿‡å¤š"
          description: "Redisè¿æ¥æ•°è¶…è¿‡100: {{ $value }}"

  # ğŸŒ Nginxå‘Šè­¦
  - name: nginx-alerts
    rules:
      # NginxæœåŠ¡ä¸å¯ç”¨
      - alert: NginxDown
        expr: up{job="nginx"} == 0
        for: 1m
        labels:
          severity: critical
          service: nginx
        annotations:
          summary: "NginxæœåŠ¡ä¸å¯ç”¨"
          description: "Nginxåå‘ä»£ç†æœåŠ¡å·²åœæ­¢å“åº”è¶…è¿‡1åˆ†é’Ÿ"

      # Nginxé”™è¯¯ç‡è¿‡é«˜
      - alert: NginxHighErrorRate
        expr: |
          rate(nginx_http_requests_total{status=~"4..|5.."}[5m]) / 
          rate(nginx_http_requests_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: warning
          service: nginx
        annotations:
          summary: "Nginxé”™è¯¯ç‡è¿‡é«˜"
          description: "5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡5%: {{ $value }}%"

  # ğŸ–¥ï¸ ç³»ç»Ÿèµ„æºå‘Šè­¦
  - name: system-alerts
    rules:
      # ç£ç›˜ç©ºé—´ä¸è¶³
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / 
           node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "ç£ç›˜ç©ºé—´ä¸è¶³"
          description: "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´å°‘äº20%: {{ $value }}%"

      # ç³»ç»Ÿè´Ÿè½½è¿‡é«˜
      - alert: HighSystemLoad
        expr: node_load1 > 4
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜"
          description: "1åˆ†é’Ÿå¹³å‡è´Ÿè½½è¶…è¿‡4: {{ $value }}"

      # ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜
      - alert: HighSystemMemory
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 10m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%: {{ $value }}%"

  # ğŸ” å¤–éƒ¨æœåŠ¡å‘Šè­¦
  - name: external-service-alerts
    rules:
      # ç½‘ç«™ä¸å¯è®¿é—®
      - alert: WebsiteDown
        expr: probe_success{job="blackbox"} == 0
        for: 2m
        labels:
          severity: critical
          service: website
        annotations:
          summary: "ç½‘ç«™ä¸å¯è®¿é—®"
          description: "ç½‘ç«™ {{ $labels.instance }} æ— æ³•è®¿é—®è¶…è¿‡2åˆ†é’Ÿ"

      # ç½‘ç«™å“åº”æ—¶é—´è¿‡é•¿
      - alert: WebsiteSlowResponse
        expr: probe_duration_seconds{job="blackbox"} > 5
        for: 5m
        labels:
          severity: warning
          service: website
        annotations:
          summary: "ç½‘ç«™å“åº”æ—¶é—´è¿‡é•¿"
          description: "ç½‘ç«™ {{ $labels.instance }} å“åº”æ—¶é—´è¶…è¿‡5ç§’: {{ $value }}s"

      # SSLè¯ä¹¦å³å°†è¿‡æœŸ
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
        for: 1h
        labels:
          severity: warning
          service: ssl
        annotations:
          summary: "SSLè¯ä¹¦å³å°†è¿‡æœŸ"
          description: "SSLè¯ä¹¦å°†åœ¨30å¤©å†…è¿‡æœŸ: {{ $labels.instance }}"

  # ğŸ“± ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
  - name: business-alerts
    rules:
      # å›¾ç‰‡åˆ†æå¤±è´¥ç‡è¿‡é«˜
      - alert: HighImageAnalysisFailureRate
        expr: |
          (
            rate(image_analysis_total{status="failed"}[10m]) /
            rate(image_analysis_total[10m])
          ) * 100 > 10
        for: 10m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "å›¾ç‰‡åˆ†æå¤±è´¥ç‡è¿‡é«˜"
          description: "10åˆ†é’Ÿå†…å›¾ç‰‡åˆ†æå¤±è´¥ç‡è¶…è¿‡10%: {{ $value }}%"

      # OCRæœåŠ¡è°ƒç”¨å¤±è´¥
      - alert: OCRServiceFailure
        expr: |
          rate(ocr_requests_total{status="failed"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: ocr
        annotations:
          summary: "OCRæœåŠ¡è°ƒç”¨å¤±è´¥"
          description: "OCRæœåŠ¡è°ƒç”¨å¤±è´¥ç‡å¼‚å¸¸: {{ $value }}/min"

      # ç”¨æˆ·ç™»å½•å¤±è´¥ç‡è¿‡é«˜
      - alert: HighLoginFailureRate
        expr: |
          (
            rate(user_login_total{status="failed"}[10m]) /
            rate(user_login_total[10m])
          ) * 100 > 20
        for: 10m
        labels:
          severity: warning
          service: auth
        annotations:
          summary: "ç”¨æˆ·ç™»å½•å¤±è´¥ç‡è¿‡é«˜"
          description: "10åˆ†é’Ÿå†…ç™»å½•å¤±è´¥ç‡è¶…è¿‡20%: {{ $value }}%"